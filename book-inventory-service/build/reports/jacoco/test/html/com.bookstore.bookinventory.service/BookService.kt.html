<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">book-inventory-service</a> &gt; <a href="index.source.html" class="el_package">com.bookstore.bookinventory.service</a> &gt; <span class="el_source">BookService.kt</span></div><h1>BookService.kt</h1><pre class="source lang-java linenums">package com.bookstore.bookinventory.service

import com.bookstore.bookinventory.dto.BookRequestDTO
import com.bookstore.bookinventory.dto.BookResponseDTO
import com.bookstore.bookinventory.model.*
import com.bookstore.bookinventory.repository.*
import com.bookstore.bookinventory.exception.BookNotFoundException
import com.bookstore.bookinventory.exception.BookAlreadyExistsException
import jakarta.transaction.Transactional
import org.slf4j.LoggerFactory
import org.springframework.stereotype.Service
import org.springframework.security.access.prepost.PreAuthorize
import java.time.LocalDateTime

<span class="fc" id="L15">@Service</span>
<span class="fc" id="L16">class BookService(</span>
<span class="fc" id="L17">    private val bookRepository: BookRepository,</span>
<span class="fc" id="L18">    private val bookPriceRepository: BookPriceRepository,</span>
<span class="fc" id="L19">    private val bookInventoryRepository: BookInventoryRepository,</span>
<span class="fc" id="L20">    private val inventoryLogRepository: InventoryLogRepository</span>
) {
<span class="fc" id="L22">    private val logger = LoggerFactory.getLogger(BookService::class.java)</span>

    @PreAuthorize(&quot;hasAnyAuthority('ADMIN', 'SUPERADMIN')&quot;)
    @Transactional
    fun createBook(request: BookRequestDTO): BookResponseDTO {
<span class="fc" id="L27">        logger.info(&quot;Creating book: {}&quot;, request.title)</span>
<span class="pc bpc" id="L28" title="1 of 2 branches missed.">        if (bookRepository.existsByIsbnAndIsDeletedFalse(request.isbn!!)) {</span>
<span class="nc" id="L29">            logger.warn(&quot;Book with ISBN already exists: {}&quot;, request.isbn)</span>
<span class="nc" id="L30">            throw BookAlreadyExistsException()</span>
        }
<span class="fc" id="L32">        val now = LocalDateTime.now()</span>
<span class="fc" id="L33">        val book = bookRepository.save(</span>
<span class="fc" id="L34">            Book(</span>
<span class="fc" id="L35">                title = request.title!!,</span>
<span class="fc" id="L36">                author = request.author!!,</span>
<span class="fc" id="L37">                genre = request.genre!!,</span>
<span class="fc" id="L38">                isbn = request.isbn,</span>
<span class="fc" id="L39">                createdAt = now,</span>
<span class="fc" id="L40">                updatedAt = now,</span>
<span class="fc" id="L41">                isDeleted = false</span>
            )
        )
<span class="fc" id="L44">        bookPriceRepository.save(BookPrice(bookId = book.id, price = request.price!!))</span>
<span class="fc" id="L45">        bookInventoryRepository.save(BookInventory(bookId = book.id, quantity = request.quantity!!))</span>
<span class="fc" id="L46">        inventoryLogRepository.save(</span>
<span class="fc" id="L47">            InventoryLog(</span>
<span class="fc" id="L48">                bookId = book.id,</span>
<span class="fc" id="L49">                action = InventoryAction.CREATE,</span>
<span class="fc" id="L50">                quantity = request.quantity,</span>
<span class="fc" id="L51">                timestamp = now</span>
            )
        )
<span class="fc" id="L54">        logger.info(&quot;Book created successfully: {}&quot;, book.id)</span>
<span class="fc" id="L55">        return toResponseDTO(book)</span>
    }

    @PreAuthorize(&quot;hasAnyAuthority('ADMIN', 'SUPERADMIN')&quot;)
    fun getBook(id: Long): BookResponseDTO {
<span class="fc" id="L60">        logger.info(&quot;Fetching book with id: {}&quot;, id)</span>
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">        val book = bookRepository.findByIdAndIsDeletedFalse(id)</span>
<span class="nc" id="L62">            ?: throw BookNotFoundException()</span>
<span class="fc" id="L63">        return toResponseDTO(book)</span>
    }

    @PreAuthorize(&quot;hasAnyAuthority('ADMIN', 'SUPERADMIN')&quot;)
    fun listBooks(): List&lt;BookResponseDTO&gt; {
<span class="fc" id="L68">        logger.info(&quot;Listing all books&quot;)</span>
<span class="fc" id="L69">        return bookRepository.findByIsDeletedFalse().map { toResponseDTO(it) }</span>
    }

    @PreAuthorize(&quot;hasAnyAuthority('ADMIN', 'SUPERADMIN')&quot;)
    @Transactional
    fun updateBook(id: Long, request: BookRequestDTO): BookResponseDTO {
<span class="fc" id="L75">        logger.info(&quot;Updating book with id: {}&quot;, id)</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">        val book = bookRepository.findByIdAndIsDeletedFalse(id)</span>
<span class="nc" id="L77">            ?: throw BookNotFoundException()</span>
<span class="fc" id="L78">        val now = LocalDateTime.now()</span>
<span class="fc" id="L79">        val updatedBook = bookRepository.save(</span>
<span class="fc" id="L80">            book.copy(</span>
<span class="fc" id="L81">                title = request.title!!,</span>
<span class="fc" id="L82">                author = request.author!!,</span>
<span class="fc" id="L83">                genre = request.genre!!,</span>
<span class="fc" id="L84">                isbn = request.isbn!!,</span>
<span class="fc" id="L85">                updatedAt = now</span>
            )
        )
<span class="pc bpc" id="L88" title="2 of 4 branches missed.">        bookPriceRepository.findByBookId(id)?.let {</span>
<span class="fc" id="L89">            bookPriceRepository.save(it.copy(price = request.price!!))</span>
<span class="pc" id="L90">        } ?: bookPriceRepository.save(BookPrice(bookId = id, price = request.price!!))</span>
<span class="fc" id="L91">        inventoryLogRepository.save(</span>
<span class="fc" id="L92">            InventoryLog(</span>
<span class="fc" id="L93">                bookId = id,</span>
<span class="fc" id="L94">                action = InventoryAction.UPDATE,</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">                quantity = bookInventoryRepository.findByBookId(id)?.quantity ?: 0, // Log current quantity for audit</span>
<span class="fc" id="L96">                timestamp = now</span>
            )
        )
<span class="fc" id="L99">        logger.info(&quot;Book updated successfully: {}&quot;, id)</span>
<span class="fc" id="L100">        return toResponseDTO(updatedBook)</span>
    }

    @PreAuthorize(&quot;hasAnyAuthority('ADMIN', 'SUPERADMIN')&quot;)
    @Transactional
    fun softDeleteBook(id: Long) {
<span class="fc" id="L106">        logger.info(&quot;Soft deleting book with id: {}&quot;, id)</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        val book = bookRepository.findByIdAndIsDeletedFalse(id)</span>
<span class="nc" id="L108">            ?: throw BookNotFoundException()</span>
<span class="fc" id="L109">        bookRepository.save(book.copy(isDeleted = true, updatedAt = LocalDateTime.now()))</span>
<span class="fc" id="L110">        inventoryLogRepository.save(</span>
<span class="fc" id="L111">            InventoryLog(</span>
<span class="fc" id="L112">                bookId = id,</span>
<span class="fc" id="L113">                action = InventoryAction.SOFT_DELETE,</span>
<span class="fc" id="L114">                quantity = 0,</span>
<span class="fc" id="L115">                timestamp = LocalDateTime.now()</span>
            )
        )
<span class="fc" id="L118">        logger.info(&quot;Book soft deleted: {}&quot;, id)</span>
<span class="fc" id="L119">    }</span>

    private fun toResponseDTO(book: Book): BookResponseDTO {
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">        val price = bookPriceRepository.findByBookId(book.id)?.price ?: 0.0</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">        val quantity = bookInventoryRepository.findByBookId(book.id)?.quantity ?: 0</span>
<span class="fc" id="L124">        return BookResponseDTO(</span>
<span class="fc" id="L125">            id = book.id,</span>
<span class="fc" id="L126">            title = book.title,</span>
<span class="fc" id="L127">            author = book.author,</span>
<span class="fc" id="L128">            genre = book.genre,</span>
<span class="fc" id="L129">            isbn = book.isbn,</span>
<span class="fc" id="L130">            price = price,</span>
<span class="fc" id="L131">            quantity = quantity,</span>
<span class="fc" id="L132">            createdAt = book.createdAt,</span>
<span class="fc" id="L133">            updatedAt = book.updatedAt,</span>
<span class="fc" id="L134">            isDeleted = book.isDeleted</span>
        )
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>